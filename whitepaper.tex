\documentclass[a4paper]{article}
\usepackage{fontspec, xunicode, xltxtra}
\usepackage{titlesec}
\usepackage{xeCJK}
\setCJKfamilyfont{song}{SimSun} 
\setCJKmainfont{simsun.ttc} % 默认中文字体为宋体
\usepackage[left=3cm, right=3cm]{geometry} % 页边距3cm
\usepackage[strings]{underscore}
\usepackage{amsmath}
\usepackage{algorithm}
\usepackage[noend]{algpseudocode}
\usepackage[title]{appendix}
\usepackage{graphicx}
\usepackage{enumitem}
\usepackage{setspace}
\usepackage[hyphens]{url}
\usepackage[hidelinks]{hyperref}
\hypersetup{breaklinks=true}
\usepackage{array}
\usepackage{caption}
\usepackage{subcaption}

\usepackage{float}

\renewcommand{\arraystretch}{1.5}

\renewcommand{\abstractname}{摘要}
\renewcommand{\figurename}{图}
\renewcommand{\appendixname}{附录}
\renewcommand{\tablename}{表}
\renewcommand{\contentsname}{目录}
\renewcommand{\refname}{参考文献}

% 1.5倍行间距
\renewcommand{\baselinestretch}{1.5}

\begin{document}

\begin{titlepage}
	\begin{center}
		\vspace*{1cm}

		\Huge
		\textbf{安全共享网络及\\基于下一代工作量证明的共识网络}

		\vspace{2cm}

		\includegraphics[width=0.6\textwidth]{figures/logo.jpeg}

		\normalsize
		2022.06.10 \\ Version 4.0
	\end{center}
\end{titlepage}

\centerline{执行摘要}
这篇白皮书陈述了Deeper项目的产品应用场景，技术框架及其实现细节。Deeper项目分为安全的网络资源共享平台，真正去中心化的共识网络和可信互联网开发平台三大阶段。目前安全的网络资源共享平台已经开发完毕，经过一段时间的公测后，我们已于2019年初正式发布一款名为Deeper Connect的智能安全硬件。它对于用户来说既是一款网络安全设备又是一款能盈利的网络资源共享设备。此外，所有用户的Deeper Connect可以通过Deeper独创的NPoW (Next-gen Proof-of-Work)共识机制，组成一个真正的去中心化共识网络，而该网络可以进一步作为可信互联网的开发平台。Deeper Connect是第一个结合了网络安全技术，网络共享经济，以及区块链技术的新物种。

Deeper Connect的设计理念是即插即用以及零配置，让用户无门槛的享受网络安全技术所带来的保护。用户不需要任何专业知识或使用说明，而只需要用网线将设备连接在调制解调器和路由器之间就可以使用。而这个简单的操作能够为用户实现突破网络干扰，防御网络攻击，流量控制，家长控制，分享网络带宽盈利和区块链挖矿等功能。

从网络安全技术角度看，DeeperConnect能够提供一体化的网络安全解决方案。网络安全功能的核心是Deeper自主研发的AtomOS网络操作系统。AtomOS是世界上第一个无锁的网络操作系统，它先进的无锁设计是保障整个系统具有高可靠，高性能，高可扩展性的关键。另外，Deeper独创了三叉戟协议， 自适应隧道，智能路由，IP复用，以及隧道层拥塞控制等创新技术，来向用户提供更深层次的安全保障和更好的用户体验。

从区块链技术角度看，Deeper通过智能合约在区块链上实现网络资源共享平台。它主要包括了代币合约、节点合约、信用合约、质押合约和微支付合约。我们推出一个全新的智能合约区块链平台 --- Deeper链。Deeper链使用Deeper独创的基于NPoW证明的共识机制来实现真正的去中心化公链平台。同时Deeper链具备高效率，低能耗，安全性的特点，是新一代的公链平台。在Deeper链主网上线后，用户所拥有的Deeper Connect可以参与Deeper链挖矿。DApp开发者也可以在Deeper链上开发诸如数字货币交易平台，社交平台和电商平台之类的去中心化分布式应用程序。这些基于Deeper链的新型应用程序，除了能满足用户的基本需求之外，还能更好的保护用户的隐私和数据，从而打造个人数据主权得以保障的可信互联网。

\newpage

\tableofcontents

\newpage
\section{愿景介绍}
随着互联网技术的飞速发展，我们所处的世界正在被一个东西深刻改变 --- 信息。早在1948年，香农博士就用数学方法量化了信息从而开创了信息论\cite{shannon2001}。互联网出现后，信息得到了前所未有的流通，人们所能获取的信息数量呈爆炸式增长。互联网也革命性地将知识信息平民化，使得高质量的知识信息不再成为少数阶级所拥有。自2009年起，区块链技术发展迅猛，更是开启了去中心化的信息自由时代。但是，在技术浪潮的推动下，人们往往只注重技术发展所带来的便利与利益，而忽视了这些技术的应用场景是否被恶意操控，以及这些技术的内在缺陷所带来的严重后果。

\subsection{网络犯罪}
网络病毒的传播可以说是层出不穷，屡屡给社会造成严重的危害和损失\cite{timeline-computer-viruses}。在2017年，被网络病毒成功劫持并被迫从事数字货币挖矿的计算机达到165万台\cite{hijacking-mining}。而随着物联网(IoT)发展起来的物联网病毒，不但能够劫持个人计算机，还可以劫持摄像头，智能家电，智能门锁，路由器等一切联网设备。从Mirai病毒\cite{mirai}开始发动攻击到2018年中，已经将超过60万台联网设备变为肉机\cite{study-ddos-iot}。另一方面，恶意网站发动的钓鱼式攻击通过伪装成可信的法人媒体来获得如用户名、密码和信用卡明细等个人敏感信息 \cite{phishing}。在2017年，卡巴斯基反钓鱼系统触发了2.46亿余次，15.9\%的用户成了为钓鱼网站目标\cite{spam-phishing}。从钓鱼网站造成的损失来看，在2013年12月至2016年12月期间，FBI在美国境内调查了22,000件钓鱼网站诈骗事件，总金额高达16亿美金\cite{phishing-scam}。2015年，网络犯罪所造成的损失总计高达3万亿美金，而2021年将达到每年6亿万美金\cite{cybercrime-damages}。

\subsection{信息抑制}
信息抑制包括了剥夺用户在互联网上的某些权利\cite{block-internet}。世界上许多国家出于各种原因封锁了大量的网站\cite{list-blocked-india}\cite{list-blocked-russia}\cite{websites-blocked-china}。除了信息封锁，监视也在互联网普遍存在。这些问题是如此普遍，以至于人们不得不放弃某种程度的隐私，以换取互联网的便利\cite{private-security}， 并常常在不知不觉中丧失数据隐私权\cite{privacy-awareness} (个人数据往往被服务提供商控制，甚至出售给第三方牟利\cite{isp-sell-data}\cite{kosinski2013private})。\\

\noindent 注：由于不同地区和国家的政策不同，Deeper Network将对不同地区销售的版本的无障碍特性进行调整和限制，并针对不同国家推出不同版本，以确保Deeper Network 产品能够适应其法律法规。

\subsection{网络信任危机}
数据泄露是指私有或保密数据被有意或无意地释放到了不被信任的环境\cite{data-breach}。从2005年1月至2008年5月，有大约2亿多条个人敏感记录涉嫌泄露\cite{data-breach-list}。 医疗机构在2014和2015年为此损失达62亿美金\cite{data-breach-healthcare}。在2018年，Facebook和剑桥分析数据泄露事件\cite{facebook-cambridge}再一次引起了全社会的关注。实际上，全球发生的严重数据泄露事件可谓比比皆是\cite{list-data-breach}。高度中心化的互联网带来的信息泄露甚至信息买卖副作用已经让人们产生了恐慌\cite{privacy-fears}。
基于以上种种问题不难看出，当今互联网并不是一个让人充分信任与依赖的基础设施。相反，它是一个充斥着封锁与干扰、欺骗与攻击的不可信环境。

从2009年开始，以比特币为代表的区块链技术迅猛发展。区块链技术的初衷是建立去中心化的信任网络，但是最终因为技术上没有做好充足的准备再次成为中心化控制的网络\cite{bitcoin-centralized}\cite{blockchain-centralized}，沦为少数人牟利的工具。数字货币在利益分配上的严重失衡\cite{hashrate-distribution}导致了多起人们之前认为只有在理论上才可行的51\%攻击\cite{51-attack}，这让很多人开始逐渐丧失对数字货币的信任\cite{never-invest-bitcoin}。

虽然区块链技术燃起了人们解决网络信任危机的希望，但是由于技术上的不成熟而又举步维艰。鉴于当今严峻的形势，Deeper决心尝试利用多年来在硬件设计，操作系统，网络安全以及区块链等领域所累计的技术和经验来改变这一现状。

在深入阐述Deeper项目的细节之前，首先请大家和我们一起先来了解一下Deeper所秉持的理念。Deeper产品中的所有技术都是围绕着这些理念而打造：
\begin{enumerate}
\item 我们认为，有必要让信息的流转不受到技术干扰导致无法自由访问互联网，让全人类实现真正的信息共享。
\item 我们认为，区块链技术的价值是为普通人赋能，而不是用来作为少数人牟利的工具。一个真正去中心化的共识网络必须是每个人都能够参与且能从中获益的平台，它应该是为整个社会而不是中心化的组织或者个人服务。
\item 我们认为，如同房屋，土地，存款一样，个人数据是属于公民的私有财产。私有财产神圣不可侵犯，Deeper的终极使命是结合安全技术和区块链技术打造个人数据主权得以保障的可信互联网。
\end{enumerate}

\newpage
\section{项目综述}

\subsection{Deeper Connect应用场景}
\subsubsection{引言及设计理念}
Deeper Connect是一个区块链驱动的一体化解决方案，提供真正的互联网自由，增强安全性和无障碍用户体验。Deeper Connect的设计理念是即插即用，零配置。用户无需跨越任何障碍， 就可以享受到网络 安全的保护。既不需要技术知识，也不需要复杂的用户手册。你所需要做的就是将设备插入调制解调器和路由器之间，打开设备电源，享受它的所有好处:保护免受网络攻击、设置家长控制、参与网络带宽共享和区块链挖掘。

\begin{figure}[hhhh]
\centering
\includegraphics[width=0.7\textwidth]{wp-zh/figures/product-iterations.png}
\caption{Products Iterations}
\label{fig:产品代系}
\end{figure}

\noindent 目前Deeper Connect 产品已经进行了四次的迭代：从第一代Deeper Connect Lite到第二代 Deeper Connect Mini， 到第三代Deeper Connect Nano， 再到现在第四代Deeper Connect Pico，每一个版本 都更加小型化。Deeper Connect 的愿景一直是使它尽可能接近以太网电缆，并相信通过伟大的技术融入 背景，为用户提供方便。Deeper Connect Pico代表了这种精神的最新体现。“Deeper Connect” 系列设备自面世以来已经获得了大量用户的青睐和追捧，在世界各地已经销售了数万台;  Deeper Connect Mini更是知名众筹平台Indiegogo上的 顶级产品之一。

\subsubsection{更安全，更私密和更公平的互联网解决方案}
Deeper Connect已经见证了从第一代Deeper Connect Lite到第二代Deeper Connect mini 作为一个去中心化的私有网络的节点和家庭网络的下一代防火墙。去中心化的专用网络是无服务器的分布式网络;用户数据永远不会被记录、泄露、黑客攻击或传唤。7层企业级防火墙保护用户的整个家庭网络，并能屏蔽广告和追踪，监控网络流量，在所有互联网设备上过滤NSFW和NSFC。

\subsubsection{技术力作：AtomOS,三叉戟协议，IP多路复用技术}

\noindent {\bf AtomOS}\\
Deeper Connect网络安全实力的核心在于AtomOS，这是Deeper的设计和开发的网络操作系统。AtomOS是世界上首个无锁网络操作系统。系统的高可用性、高性能和高可伸缩性都取决于其最先进的无锁设计。\\

\noindent {\bf 三叉戟协议(Trident Protocol)}\\
Deeper开发了自己的Trident协议，这是一种基于区块链的去中心化共享通信协议，具有自适应隧道和智能路由技术,提供深入的安全保护以及改进用户体验。它预防黑客攻击，保护了数据传输，最大限度地利用了网络带宽，并减少了数据包传输过程中的延迟。这多亏了诸如内部网渗透、数据加密、协议伪装和隧道层拥塞控制等网络技术的有效集成。更多细节见5.1节。\\

\noindent {\bf IP多路复用技术(IP Multiplexing)}\\
Deeper的专利IP复用技术使零IP地址配置和智能适配的路由器的IP地址自动接口与互联网实现真正的即插即用的体验Deeper Connect设备。

\subsection{Deeper Connect网络}
Deeper的价值不仅仅在于其推出的硬件设备，更在于这些设备之间互相连接所组建的网络平台。其具体表现形式为：

\begin{itemize}
\item 安全的网络资源共享平台
\item 真正去中心化的区块链共识网络
\item 可信互联网的开发平台
\end{itemize}

\noindent 梅特卡夫定律\cite{shapiro1998information}指出网络的价值是与该网络中节点数量的平方成正比的。因此，随着Deeper硬件设备布署数量的增长，设备之间所构成网络的价值将会成指数增长。

\subsubsection{家家户户通往WEB 3.0的安全网关}
Deeper Connect是世界上第一个基于区块链技术的网络安全产品。Deeper Connect因其即插即用便捷设计而受到全球网民的追捧， 它消除了技术壁垒并向所有用户提供了私密、安全、不受限制的互联网体验。Deeper的最新产品"Deeper Connect Mini”已在150多个国家/地区拥有60,000多个节点，并在知名众筹平台Indiegogo上成功筹集了272.7多万美元。作为Deeper生态系统的关口，Deeper Connect将区块链技术真正大众化并提高普罗大众对即将到来的Web3.0时代的认识。

\subsubsection{去中心化私密网络（DPN）}
Deeper的DPN采用点对点带宽共享机制，搭建端到端加密私密网络，让每个节点运营者都可以充当客户端和服务器。节点带宽共享者通过向其他节点提供无法追踪和不可阻挡的互联网访带宽分享而获得采矿奖励。与传统的P2P网络模型相比，分享激励保证了网络的稳健性。DPN是Deeper生态系统中的第一个杀手级应用程序，更是践行去中心化共享经济和个人数据的归属。

\subsubsection{去中心化边缘计算平台（DEP）}
DEP是基于Deeper设备节点所构建的链下去中心化基础设施，利用区块链平台发布去中心化的任务，Deeper节点对特定事件进行监听，解析事件触发特定的任务工作流，根据应用URL和操作参数Option，拉取、调度和监控任务在节点的执行状态，满足特定条件时结束任务。每个节点可能承担着不同的web2/web3应用，它们将轻松成为某项服务的提供者或共同提供者，通过提供开发和维护这些服务来获取收益和所有权。这样的链下去中心化平台为全新的应用形态提供可能性，适用场景包括：预言机、零网、闪电网络、触发器、邮件服务等。

\subsubsection{去中心化Youtube（D-Tube）}
D-Tube是一个去中心化的Web3.0视频创造者平台，依托于DEP的安全与网络技术，实现安全数据存储和快速流量分发功能。传统web2.0内容平台将创作者视为平台获客引流的重要组成部分，他们是平台价值和空间的创造者和所有者，但却缺乏对内容、版权和广告的控制权。D-tube将采用链下web3去中心化网站运营方式，结合链上NFT价值凭证方式，为所有创作者提供一种全新的web3交互模式。利用watch-and-earn和create-and-earn的机制，激励更多创造者和粉丝的参与和成长，为创作者带来一个去中心化、开放的创作环境。

\subsubsection{去中心化聊天软件（D-Chat）}
D-Chat是一款去中心化的web3.0聊天软件，依托于DEP的去中心化应用部署能力，快速实现大规模聊天应用节点的部署，借助DPN的隐私加密网络技术，实现消息的跨域隐私传输功能。传统web2.0聊天软件中，用户并不掌握身份和数据的处置权，平台能够随意限制个人账户的访问和使用权限，任何的聊天内容、交易记录都能够被随意监听。D-Chat将利用链下去中心化加密隧道节点，结合链上区块链身份认证和点对点交易方式，最终实现用户所创造的数字内容、所有权和控制权都归属于用户，用户所创造的价值可以由用户自主选择与他人签订协议进行分配。
\\

随着Deeper社区的发展和壮大，利用DEP链下去中心化基础执行平台，Deeper将制定更多激励计划来促进社区开发者的积极性，为用户带来丰富多彩的应用生态。

\section{硬件设备}
Deeper旨在用即插即用的安全硬件来解决安全、共享以及区块链领域的复杂技术问题，为用户提供一体化解决方案。下面我们将带您领略Deeper Connect安全硬件设计的一些特色。

\subsection{跨平台}
Deeper Connect旨在兼容不同的硬件平台。AtomOS已经成功地在 Intel和ARM64处理器上运行，这使得Deeper能够充分利用这两种平台的优势 --- Intel处理器的强大功能足以处理各种高负载网络情况，这使得Deeper不仅能够满足家庭网络的复杂使用情形，同时也可以满足企业级的应用需求。另一方面，ARM平台以低能耗、低成本著称，足以满足日常家庭网络需求以及各种移动应用场合。在未来，Deeper还计划推出基于ARM32的产品，这将进一步降低硬件成本。

\subsection{低功耗}
根据digiconomist的评估\cite{bitcoin-energy-consumption}，全球比特币挖矿耗电1.88亿千瓦时，相当于年耗电688.1亿千瓦时，是2017年5月耗电水平 (115.7亿千瓦时) 的6倍。全球比特币挖矿
总耗电量相当于捷克一个国家的耗电量，占全球电力消费的 0.31\%。平均每笔比特币交易耗电968千瓦时，相当于美国32个家庭一天的用电量。目前比特币全年碳排放为3,385 万吨，平均每块比特币需要排放1,300公斤的二氧化碳\cite{bitcoin-energy-consumption2}。

由Deeper独创的NPoW证明算法可以从根本上解决这个问题，NPoW算法可以让设备以极低的运算量参与网络共识。Deeper Connect选取低功耗的嵌入式处理器来打造我们的共享和共识网络。我们已经设计完毕的Deeper Connect的最大功耗是15W，新一代便携式产品Deeper Connect Pico最大功耗仅1W。搭载AtomOS的Deeper硬件是市面上性能功耗比最高的安全产品(与普通的ASIC/GPU挖矿设备相比，能耗降低了大约三个数量级)，未来Deeper Connect也有可能成为收益功耗比最高的区块链矿机。

\begin{table} [hh]
\centering
\begin{tabular}{|l|l|}
\hline
硬件类型 & 功耗 \\ \hline
Deeper Connect & 1$\sim$15W \\ \hline
ASIC矿机 & 2,000$\sim$3,000W \\ \hline
GPU矿机 & 1,000$\sim$2,000W \\ \hline
\end{tabular}
\caption{不同类型矿机的功耗对比} 
\label{tab:power}
\end{table}

\subsection{加密货币的硬件钱包}
Deeper的安全硬件集成了加密货币钱包功能，旨在为没有任何区块链以及安全相关知识背景的用户提供最高级别的加密货币安全保障。

Deeper Connect通过AtomOS提供的多重安全保障，使得黑客和恶意组织无法远程获取对硬件的控制权限，从而无法更进一步获取存储在设备上的密钥信息。同时恶意攻击将被识别和记录，为今后进一步破获网络犯罪以及抓捕黑客做好准备。

\begin{figure}[hhhh]
\centering
\includegraphics[width=0.45\textwidth]{figures/hardware-wallet.png}
\caption{黑客对Deeper Connect的恶意访问将被阻止并记录}
\label{fig:hardware-wallet}
\end{figure}

Deeper Connect采用了三重加密技术来保证其存储设备的安全。即使用户的硬件设备被盗取，他人依然无法破解设备上存储的密钥信息。所以，Deeper的存储设备将具备极高强度的保密性。接下来分别阐述Deeper的三重加密技术。

\subsubsection{块设备加密}
当用户的存储设备被盗取后，黑客可以通过分析块设备上的数据来获得重要的文件。Deeper Connect通过对每个磁盘块进行AES-CBC \cite{frankel2003aes} (图 \ref{fig:aes-cbc})加密使得黑客只能得到加
密后的数据，从而极大增大了其破解难度。

\begin{figure}[hhhh]
\centering
\includegraphics[width=0.5\textwidth]{figures/aes-cbc.png}
\caption{Deeper Connect 对磁盘数据块进行AES-CBC加密}
\label{fig:aes-cbc}
\end{figure}

\subsubsection{文件系统加密}
单纯使用块设备加密技术并不是万无一失的。为了进一步保护我们的存储介质，Deeper对通用文件的关键元数据以及普通数据的组织方式进行了重新组织，从而实现了Deeper自有格式的文件系统 --- DeeperFS。由于DeeperFS的数据结构严格保密，使得黑客无法从块设备中获取文件系统的结构信息，从而无法更进一步获得存放在文件系统中的关键文件(图 \ref{fig:file-encryption})。

\begin{figure}[hhhh]
\centering
\includegraphics[width=0.5\textwidth]{figures/file-encryption.png}
\caption{加密的文件系统将保护磁盘文件不被提取}
\label{fig:file-encryption}
\end{figure}

\subsubsection{文件加密}
Deeper Connect设备上的所有重要文件都是经过AES-CBC加密后存储在文件系统上的。所有文件的秘钥是固化在Deeper的应用程序的内部，只有Deeper的应用程序才能够打开获取到这些数据的明文信息。

\begin{figure}[hhhh]
\centering
\includegraphics[width=0.45\textwidth]{figures/3-level-encryption.png}
\caption{三重加密技术将保障Deeper Connect的数据安全}
\label{fig:3-level-encryption}
\end{figure}

\subsection{安全矿机}
2018年5月28日，以太坊被发现“致命报文”漏洞 (CVE-2018-12018)\cite{ethereum-bug}，攻击
者通过发送一个恶意报文即可向geth节点发动攻击。geth是以太坊主流的官方客户端，对于以太坊至关重要。有大约70\%的节点运行在geth之上，包括交易所和矿池这些关键节点。通过这个漏洞，攻击者可以直接让以太坊瘫痪。一旦成功，以太坊市场
将面临巨震。

目前的矿机产品都没有在安全上引起足够的重视。但我们可以想象，如果黑客能够利用挖矿软件或者矿机自身的漏洞来进行攻击，那么该矿机所承载的区块链的价值也将大打折扣。
Deeper的所有产品都自带安全基因，都是经过精密设计并且反复进行安全论证与测试的。运行AtomOS的Deeper安全硬件将是有史以来最安全的矿机，Deeper的安全矿机将最大程度上保护Deeper链的安全，同时也能最大程度的保护矿工的利益。

\begin{figure}[hhhh]
\centering
\includegraphics[width=0.55\textwidth]{figures/secure-miner.png}
\caption{Deeper Connect自带安全基因将为 Deeper链提供额外防护}
\label{fig:secure-miner}
\end{figure}

\newpage
\section{操作系统}
Deeper的软件架构由数据平面，管理平面和控制平面组成(图 \ref{fig:architecture})。其中，数据平面负责用户数据包的收发与深度检测，它是由Deeper自主开发的AtomOS来实现的。管理平面负责为用户提供友好的使用界面，方便用户监控系统运行或更改系统设置。控制平面负责设备与区块链之间的交互，设备之间的交互以及区块链共识等功能。

\begin{figure}[hhhh]
\centering
\includegraphics[width=0.43\textwidth]{figures/architecture.png}
\caption{软件架构图}
\label{fig:architecture}
\end{figure}

本章重点介绍AtomOS，它是为网络深层安全而特别打造的网络操作系统，也是世界上第一个无锁的网络操作系统。它先进的设计是保障整个系统可靠性，高效性，安全性的基础。下面我们将从数据包收发，数据包调度和数据包深层检测三个部分来简要介绍AtomOS。

\subsection{数据包收发}
数据包收发属于AtomOS的I/O层，它是决定用户数据流延迟和吞吐速率的关键技术之一。传统的操作系统利用内核网络协议栈收发数据。这个方法的缺点是高延迟和低吞吐。当数据包经过网络传输到达设备后，它需要经过网卡，网卡驱动，内核网络栈，Socket等一系列中间处理才能抵达程序开始真正处理(图 \ref{fig:packet-io})。另外，这个方法还会导致频繁的上下文切换和大量的中断处理，进一步加剧了数据延迟并且降低了吞吐速率。

\begin{figure}[hhhh]
\centering
\includegraphics[width=0.6\textwidth]{figures/packet-io.png}
\caption{传统操作系统数据收发}
\label{fig:packet-io}
\end{figure}

AtomOS采用了零拷贝技术直接从网络设备上获取数据包(图 \ref{fig:dpdk})。这不但绕过了繁琐的Linux内核网络协议栈，也避免了频繁的上下文切换以及大量的中断处理，从而大大降低了数据延迟并提高了吞吐速率。AtomOS采用Intel发布的DPDK\cite{dpdk}开发套件来实现数据包的零拷贝。根据Intel提供的实验数据证明DPDK能够将吞吐速率提高10倍\cite{dpdk-performance}。

\begin{figure}[hhhh]
\centering
\includegraphics[width=0.68\textwidth]{figures/dpdk.png}
\caption{DPDK数据收发}
\label{fig:dpdk}
\end{figure}

\subsection{数据包调度}
AtomOS是采用独创的HIPE数据结构开发的世界上第一个无锁的网络操作系统。它将网络操作系统的设计难点通过HIPE一并解决，从而实现了AtomOS的设计哲学：简单，高效，可控。在详细介绍HIPE之前，我们先来看看现有的网络系统存在
哪些普遍的需求和问题。

首先是高性能和高可扩展性的需求。随着CPU晶体管的体积越来越小，登纳德缩放定律\cite{dennard1974design}逐渐失效。晶体管尺寸缩小以后，静态功耗不减反增，带来了很大的热能转换，加之晶体管之间的积热十分严重，让CPU散热成为亟待解决的问题。单纯提高CPU时钟频率由于随之而来的散热问题而变得不再现实，所以各大芯
片厂商都很识趣地停止了高频芯片的研发，转而向低频多核的架构开始研究。著名的网络处理器生产厂商Cavium早在2012年就推出了48核心的网络处理器\cite{cavium-48-core}，而AMD也在2019年量产其128线程多核处理器\cite{amd-64-core}。多核处理器的发展也为网络操作系统的设计带来挑战。传统的网络操作系统通常基于vxWorks、FreeBSD、Linux这些经典操作系统。vxWorks在设计之初只是作为一个单核的嵌入式实时操作系统，最近十年来已被网络设备厂商逐渐淘汰。Linux和FreeBSD都是基于UNIX衍生而来，而UNIX最初是以控制系统而非数据转发系统为应用场景而作出的设计。这些经典操作系统先天的设计缺陷使得他们完全无法充分发挥多核乃至众核处理器带来的优势。

其次是高可用性的需求。网络操作系统通常都部署在各种联网设备的边界，一旦网络设备失效，将影响该设备所连接网络中的所有设备的正常使用。因此人们对网络设备的可用性要求非常之高。一般来讲，网络设备的可用度要求达到99.999\%，即每年只能有5分钟的故障时间。由于现在网络设备，尤其是网络安全设备所承载的流量和功能越来越多，想要保障设备的高可用性也变得越发困难。

最后，是数据包保序的需求。当用户访问互联网上的服务时，中间需要经过十几个甚至几十个网络设备。如果这些设备不按照约定对数据包进行保序的话，用户的数据包在经过这么多设备再到达终点的时候将严重乱序。乱序会触发TCP协议的拥塞控制算法\cite{jacobson1988congestion}减小TCP发送窗口的长度，从而严重降低用户数据流的速度，影响用户的使用体验。正如我们在前面所讲，现在多核乃至众核处理器已经成为主流，多核处理器在对数据包进行并发处理时，虽然能够加快数据的处理速度，但如果处理不当也容易产生严重的乱序问题。如何既能充分利用多核处理器的潜力，又能保证数据包的顺序成为了网络操作系统必须解决的问题。

目前所有的操作系统都不得不用锁\cite{lock}来尝试解决这些问题。然而锁的设计已经成为了网络操作系统的一个难题。如果锁的粒度设计过大，对于当前核数越来越多的处理器而言，这些大锁会成为整个系统的瓶颈。如果锁的粒度设计过小，虽然操作系统的性能有可能得到提升，但是随之而来的就会引入让开发者最为头疼的死锁以及各种竞态 (race condition)问题。这些问题如果处理不当，则会对系统的稳定性产生极大的影响。

为了满足以上网络系统的普遍需求并解决传统操作系统的问题，AtomOS采用HIPE数据结构对操作系统的共享资源进行全局调度，既保证了系统的正确性又能让AtomOS充分发挥多核的性能优势。接下来，我们简单介绍一下HIPE的实现原理。

操作系统的各种共享资源被分为$N$个组。其中大的共享资源可能横跨多个组，小的共享资源则隶属于单个组。每个资源组的访问都是由事件触发。每个需要访问共享资源的事件都会被放入到相应资源组的无锁队列中。当队列中的事件出队时，会自动分配一个CPU核心来对其进行处理。由于HIPE限制每个资源组相应的无锁队列中的所有事件必须依次处理而不能同时处理，从而实现了对共享资源的保护。由于系统中资源组的数目远远大于CPU核心的数目，所有CPU核心都可以获得足够的数据资源去不断处理数据，使得整个系统的性能和CPU核数完全成线性关系。

\begin{figure}[hhhh]
\centering
\includegraphics[width=0.85\textwidth]{figures/resource-groups.png}
\caption{操作系统资源��划分为$N$个组}
\label{fig:resource-groups}
\end{figure}

\begin{figure}[hhhh]
\centering
\includegraphics[width=0.85\textwidth]{figures/event-queue.png}
\caption{对每个资源组的访问由无锁队列中的事件触发}
\label{fig:event-queue}
\end{figure}

\begin{figure}[hhhh]
\centering
\includegraphics[width=0.85\textwidth]{figures/cpu-access.png}
\caption{每个CPU可以同时访问不同的资源组}
\label{fig:cpu-access}
\end{figure}

无锁的设计不但使得包处理拥有较高的可扩展性 (scalability)，而且也避免了并发程序同时运行时容易引入的各种竞态 (race condition) 问题。不仅如此，由于数据包是在HIPE管道中进行顺序流动，这就保证了经过AtomOS处理后的用户数据流内的数据包顺序和原始数据流内的数据包顺序是一致的。

\subsection{数据包深层检测}
\label{sec:packet-inspection}
数据包深层检测是保证用户数据流完全充分保护的关键技术。AtomOS针对OSI七层模型的各个层面都做了相应的连接保障和安全防护 (表 \ref{tab:osi})，从而使Deeper Connect拥有一个完整的防火墙功能。

\begin{table} [hh]
\centering
\begin{tabular}{|l|l|}
\hline
第七层：应用层 & 应用识别，恶意数据流检测 \\ \hline
第六层：表示层 & 数据加解密，防止重放攻击 \\ \hline
第五层：会话层 & HTTP/SIP等协议会话层检查 \\ \hline
第四层：传输层 & 严格状态检查，防止Flood攻击 \\ \hline
第三层：网络层 & 分片攻击防护，IP欺骗防护 \\ \hline
第二层：链路层 & ARP欺骗保护 \\ \hline
第一层：物理层 & 掉电连接保持 \\ \hline
\end{tabular}
\caption{OSI七层深度防护} \label{tab:osi}
\end{table}

现在网络安全的重心已经从低层协议转移到了高层协议，AtomOS除了对网络1–3层做了各种保护之外，还针对4–7层重点实现了以下高级防火墙功能：

\begin{itemize}
\item 严格的TCP状态检查以防止可能的TCP伪装和劫持：对于每个TCP连接，AtomOS都会在会话表中跟踪其状态，只有严格满足TCP状态机的数据包才继续转发。同时在实现上参考了业内权威的NSSlab防火墙测试用例，以保证已知的各种TCP逃逸方法不能成功。

\item 应用程序识别和流量控制：AtomOS内集成了一个稳定高效、可扩展的应用程序识别引擎，可以识别常见的家用流量并根据需求进行流量控制或者智能路由，保证用户的关键应用的上网体验的同时，保证在对外提供隧道服务时不会占用过多的本地资源。

\item URL过滤：AtomOS可以对恶意网站(包括恶意软件下载、钓鱼网站等) 进行自动过滤，保证用户安全的上网环境。用户也可以根据需求启用家长控制功能，根据家庭成员的不同，来区分可以访问的互联网内容。

\item 网络地址和端口转换(NAPT)：默认情况下，AtomOS尽可能不对内部流量进行网络地址和端口转换，目的是尽可能维持网线式零配置上网。某些情况下，根据需要，AtomOS也可以完成对称模式的NAPT，进一步隐藏用户的内网结构。
\end{itemize}

\newpage
\section{网络技术}
除了前文所介绍的网络深层安全功能之外，Deeper还独创了三叉戟协议，自适应隧道，智能路由，链路层隧道以及隧道层拥塞控制等创新技术。向用户提供最深层次的安全保障和更好的用户体验。

\subsection{三叉戟协议}
Deeper的隧道技术的核心是实现自由无障碍访问互联网，这是由三叉戟协议来实现的。互联网访问监查是对用户的上网流量进行全方位的监视和过滤\cite{internet-censorship}，依靠在核心网络和关键出口部署大量网络防火墙和离线分析设备来实现的。所以，为了介绍三叉戟协议的穿透性，我们先来回顾一下网络防火墙的工作原理。目前，网络防火墙从初级的基于端口的访问控制表模式已经进化到基于内容识别的智能模式。这个模式有以下诸多具体实现方法。前四个方法属于被动识别方法而第五个方法属于主动识别方法。部分防火墙可以同时利用其中几个方法对用户数据流进行应用类型识别，甚至结合贝叶斯 (Bayes’ theorem) \cite{russell2016artificial}或判决树\cite{rokach2008data} 等人工智能算法进行智能识
别。

\subsubsection{端口粗过滤}
端口粗过滤是指根据目的端口判断其可能的应用类型的方法。互联网号码分配局IANA\cite{iana}是制定网络端口及其相应网络应用的机构。截止目前，端口0至端口1024已经基本分配完毕\cite{list-port-number}。通过网络端口，防火墙可以大概判断其可能运行的协议。比如NFS协议常用的目的端口是2049，只要出现了该端口的流量，即使没有出现明显的内容特征，也可以大概判定其应用类型。 
\subsubsection{内容识别}
内容识别是指根据用户数据流内容来识别其网络应用类型的方法。由于网络应用是依照提前制定的网络协议来完成的，用户数据流往往会具有某种的内容特征。比如HTTP常用数个命令 (GET/POST 等) 都会出现在TCP协商完成的第一个数据包的最开始，并且第一个行总是以HTTP/X.X (使用的 HTTP 版本号) 结尾，防火墙就可以使用该特征判断出在任何目的端口上允许的HTTP协议。类似的，所有国际标准组织的制定标准协议都有明显的内容特征。对于一些非标准协议，其内容特征可能随版本的升级而发生改变，就需要防火墙也相应的定期更新自己的特征库才能跟上众
多软件的特征变化。

\subsubsection{数据包长度识别}
据包长度识别是根据交互数据包的长度序列和分布来进行应用识别的方法。在用户数据流没有明显的内容特征时，这个方法非常实用。在网络协议的协商阶段，服务器和客户端之间发送的网络包长度往往存在着一定规律。假如一个网络协议在协商阶段规定：客户端要发送一个负载长度为60字节的TCP数据包发起请求，服务器收到后需回复一个长度为40字节的数据包作为回复内容和一个长度在20–30字节之间的数据包作为另一个回复内容。那么这个网络协议就具有了一定数据包长度特征，这完全可以被防火墙加以利用并作为应用识别。为了躲过防火墙的这类识别，应用程序需要通过进行扰码或者加密等手段来打乱长度特征。

\subsubsection{数据包间隔识别}
数据包间隔识别是根据网络协议中规定的周期性的保活数据包来进行应用识别的方法。在隧道协议中，服务器和客户端为了监控隧道可用状态需要周期性的发送保活数据包。这个数据包一般会以固定的周期间隔发送并且长度较小。即使是一些非标准的隧道连接应用，也往往具有这个网络协议的规律。用来进行网络干扰的网络技术可以利用这个规律来识别隧道应用从而进行屏蔽。

\subsubsection{主动检测识别}
主动检测识别是指防火墙作为中间人改动客户端发给服务器的数据包内容并根据服务器返回的数据包内容来进行应用识别的方法。比如恶意软件常用的IRC\cite{reed1993rfc}控制通道虽然符合标准的IRC协议 (IETF制定的网络聊天协议)，但是往往却并不支持常用的IRC命令的简单变形。防火墙利用这一特征通过主动发送一些命令来测试服务器回复，从而识别该网络应用是正常的聊天应用还是恶意软件的控制通道。可以看出，主动检测识别和上面所述的被动方法完全不同。它使得防火墙不仅仅通过监听数据流内容来识别应用，更通过主动修改或主动发送数据包来主动检测。

为了针对以上所有检测，三叉戟协议结合了两种隧道模式来阻止防火墙的检测：协议混淆模式和协议伪装模式。由于协议混淆模式无法被防火墙检测出任何特征，从而实现了突破网络干扰功能。但是在某些白名单系统下，凡是不能被识别的数据流同样遭到丢弃或屏蔽。此时，三叉戟协议将自动切换到协议伪装模式继续实现突破网络干扰功能。

\subsubsection{协议混淆模式}
协议混淆模式针对防火墙的各种检测手段作出相应的应对，使得防火墙无法识别出任何特征。此模式的工作方法如下：

\begin{itemize}
\item 随机端口：随机协商端口作为数据流端口。

\item 加密内容：所有数据包内容全加密；保证无法用正则表达式 (regex) 抽取内容特征。

\item 混淆数据包长度：所有数据包长度都进行随机化处理。

\item 无定期保活数据包：数据包将自行携带保活数据；无明显的保活数据包独立存。

\item 防止主动检测：服务器丢弃任何非协议规范的数据包并拒绝响应。
\end{itemize}

\subsubsection{协议伪装模式}
协议伪装模式是指将流量特征伪装成其它常见协议的流量特征。例如可以伪装成以下两种常见的协议：

\begin{itemize}
\item HTTP协议：隧道协议被完全封装在一个 “HTTP GET” 和一个 “HTTP POST”的消息体中。“GET Response” 命令用于接收下行数据，而POST消息体用于发送上行数据。由于端口是客户端和服务器双方提前随机协商的，所有HTTP部分不会出现专有的字段名称等特征。

\item TLS协议：此时利用的是TLS 1.2 的session ticket功能，隧道流量就像是在使用已经协商好的 session ticket的一个标准的HTTPS连接，由于没有经过协商阶段，防火墙也不能作为中间人进行解密/加密。AtomOS在此后负载中也会全部使用和上述协议混淆模式类似的加密和防识别机制。
\end{itemize}

\subsubsection{NAT穿越}
P2P网络的另一个常见问题是NAT\cite{nat}穿越。NAT是当前网络设备在IPv4网络环境中的常用功能。网络设备在局域网内往往配置的是私有IP地址，但是要想在互联网中传输数据包，却必须要把数据包的目的IP地址和源IP地址配置为公有IP地址。为了解决这个矛盾，在局域网出口处的网络设备可以利用NAT把从局域网向互联网传输的数据包的私有IPv4地址转换为网关的公有IP地址，从而使得数据包得以在互联网内传输。这个做法不但解决了IPv4地址有限的问题，也解决了机构或企业隐藏内部网络结构并隔离外部网络的需求。对于Deeper Connect的用户来说，网络设备很可能处于运营商的NAT设备之后，这导致Deeper Connect不得不使用私有IP地址。此时Deeper Connect就无法接收到来自互联网设备发出的连接请求，我们采用以下技术来解决这个问题：
\begin{itemize}
\item 如果连接的接受方使用私有IP地址，而发起方使用公用IP地址，则由接收方发起反向的连接请求。

\item 如果双方均使用私有IP地址，则需要进一步的NAT类型检测来判断如何发起连接请求。AtomOS在这里实现了类似STUN协议 (RFC3489 \cite{rosenbergstun})原理的私有协议，在设备进行网络注册的初期就能够知道自己所在的网络NAT类型并随本节点的其他信息一起发布到网络上。此后设备在建立端到端连接时会避免两个都在Symmetric NAT 或者Port Restricted Cone NAT之后的设备直接连接， 而对于其他
的NAT类型 (Cone NAT或者Restricted Cone NAT)，AtomOS都可以尝试进行两端的直接连接
\end{itemize}

\subsection{自适应隧道技术}
Deeper Connect采用的是高效、灵活、自适应的专有隧道协议而不是标准的IPSEC之类的隧道协议。在自适应隧道技术设计和实现的过程中，我们广泛借鉴了在业内已经较为成熟的各种广域网加速技术\cite{wan-optimization}。尤其针对跨国互联网存在的高延时、高丢包率和数据流乱序等问题，我们创新性的在数据流隧道层实现并改进了这些优化技术。这有效的提升了带宽利用率，并达到
了显著改善用户的上网体验的目标。

\subsubsection{自适应数据压缩和合并}
通过自适应隧道技术，Deeper Connect可以对用户数据流内的数据包进行可压缩判断并以此来决定是否进行压缩处理。比如互联网中最常见的HTTP协议，由于这类网络协议的内容主要是英文字符，经过压缩可以节约70\%左右的带宽，这大大提高了传输效率。然而，对于视频音频流量中常见的 MP4 等格式或采用SSL和TLS加密的HTTPS和SFTP等网络协议，由于其本身信息熵 \cite{shannon2001}已经趋
近该长度可携带数据的理论极限，压缩除了增加CPU消耗外并不能节约带宽，导致压缩处理反而降低了传输速率。所以，自适应隧道技术需要根据内容进行判断并处理，以达到提高传输效率的目的。

通过自适应隧道技术，Deeper Connect还可以通过合并发送数据量较小的数据包，以达到提高传输效率的目的。有不少网络协议由于本身设计的原因导致用户数据流内存在大量的数据量较小甚至完全没有的控制包。拿一个30KB HTTP 传送数据流举例来说，即使客户端的协议栈对TCP的优化为每两个数据包才返回一个接收端的确认包，也导致数据流内存在 40\%的小于 100字节内容的数据包。这么大比例的数据量极小的数据包大大降低了用户数据流的传输效率。自适应隧道技术可以在不影响TCP连接延时的情况下，对多个数据流内的数据包大量合并发送并再次压缩，以达到提高提高传输效率的目的 (图 \ref{fig:packet-compress}).

\begin{figure}[hhhh]
\centering
\includegraphics[width=0.8\textwidth]{figures/packet-compress.png}
\caption{数据包自动合并压缩传送示意图}
\label{fig:packet-compress}
\end{figure}

\subsubsection{基于应用类型的流量控制}
基于应用类型的流量控制可以根据用户数据流的应用类型进行相应的流量控制，以保证用户延迟敏感或流量敏感的应用数据流享有更高的网络隧道使用级别。在家用网络中，网络带宽往往有限。当用户通过多个应用程序同时使用带宽时，网络带宽的需求往往远大于实际网络带宽，这就带来了如何分配有限网络带宽的难题。自适应隧道技术可以根据用户数据流自动判断出应用类型并给其赋予相应的网络隧道使用级别。比如，网页浏览或电子邮件下载这类应用就属于用户延迟敏感或流量敏感的应用类型。而文件下载这类应用就属于用户延迟不敏感或流量不敏感的应用类型。自适应隧道技术首先可以自动估算网络隧道的实际带宽和网络隧道的带宽需求。如果供不应求的话，自适应隧道技术会根据应用的网络隧道使用级别来控制网络隧道带宽的使用。级别较低的应用数据流将被暂时缓冲在有限的数据包队列中。如果数据包队列已满，溢出的数据包将被丢弃。这虽然影响了某些应用的正常处理造成了延迟，但是在带宽有限的情况下，自适应隧道技术已经最优化了用户的上网体验。

\subsection{智能路由技术}

\begin{figure}[hhhh]
\centering
\includegraphics[width=0.8\textwidth]{figures/smart-routing.png}
\caption{智能路由技术}
\label{fig:smart-routing}
\end{figure}

智能路由技术是指根据用户数据流特征自动决定网络路由并判定是否通过隧道传输的技术。我们提供两种模式，隐私保护模式和突破网络干扰模式。在隐私保护模式下，涉及用户上网痕迹的用户数据流将根据用户设置的匿名服务级别来决定是否经过网络隧道封装处理；在突破网络干扰模式下，访问互联网的用户数据流将根据访问对象网址及其相应的允许访问地区和屏蔽访问地区数据库来决定是否经过网络隧道封装处理。

智能路由为用户提供了以下好处：
\begin{enumerate}
\item 节约成本：网络隧道是通过两个或多个Deeper Connect设备建立的，所以隧道的两端都是Deeper Connect。如果一个Deeper Connect寻求和别的Deeper Connect建立隧道连接，就必须要通过网络共享平台寻找服务器并且根据流量或网速支付数字货币。用户并不是免费使用网络隧道的。智能路由技术可以根据数据流的属性自动判定是否通过网络隧道传输。这个做法不仅减少了网络隧道的使用量，而且避免了网络隧道带来的网络延迟，使用户既保持了正常数据流的原始体验又不
会造成额外的开支。

\item 匿名服务：匿名服务指的是隐藏用户的IP地址，以达到难以追踪上网痕迹的目的。由于网络隧道是经过端到端的加密处理的，通过网络隧道传输的用户数据流将不会在互联网上留下任何痕迹。我们会根据用户访问对象的公开性设置级别，并根据用户的设置来决定是否对相应的数据流进行网络隧道封装处理。网页访问等这类公开性很强的用户数据流属于匿名服务最高级别。对于这个级别的用户数据流，网络隧道封装处理属于必选的设置。而P2P下载等这类公开性较弱的用户数据流属于匿名服务次高级别。对于这个级别的用户数据流，网络隧道封装处理属于可选的设置，以减少用户的使用成本。不仅如此，用户还可以选择多跳路由模式，以实现更加严格的匿名服务。在多跳路由环境下，网络隧道将由大于两个Deeper Connect来建立而不是一般情况下的两个Deeper Connect。这样做的好处是作为中间节点的Deeper Connect由于无法解密用户数据流而无法偷窥内容。而作为最后一个节点的Deeper Connect虽然可以解密用户数据流，但是却无法知道数据流的来源。可以看出，如果组成网络隧道的Deeper Connect越多，那么用户数据流将越难以追踪而相应的成本也越高。
\end{enumerate}

\subsection{链路层隧道技术}
AtomOS是世界上首个不需要任何配置，在虚拟网线模式下即可以实现智能路由和隧道封装的设备。当前市面上所有实现了隧道功能的网络设备都是工作在路由模式，也就是说，用户需要具备一定的网络技术能力，学会IP地址规划、隧道协议配置，才能正确的建立起隧道。还需要一定的路由知识才能把需要的流量转发到隧道中进行正确的封装、解封装。而AtomOS完全改变了对终端用户的专业知识需求，Deeper Connect设备不用具备任何专业知识，用户将AtomOS 设备接入家用路由器的上行链路后，AtomOS会先进入学习阶段，此时进行流量监听的同时不影响流量的转发，并根据两个端口出现的IP地址的统计规律自动判断其连接的方向。我们知道，互联网上
分部着数以亿计的节点，而个人用户的出口IP数目很少而且固定，所以分析很短一段时间的流量之后，我们就可以知道哪一端是上联口，哪一端是下联口。紧接着AtomOS会进一步学习上联网关IP/MAC地址，DNS服务器等一系列信息，供以后可能的隧道协商和封装使用。

我们认为，智能家庭网关本身是一个用户操作频度很低的产品，越是不需要用户随时感知到它的存在，只在需要改变功能时做最少的配置，越是满足最大部分用户的真实需求。特别的，结合上面我们独创的智能路由技术，在零使用门槛下用最低的成本完成用户的隐私保护和网络穿越需求。

\subsection{隧道层拥塞控制技术}
Deeper Network 的重要应用场景之一就是为用户提供网络匿名服务，使用户的隐私得到保护，并且可以自由地访问任何互联网内容而不被干扰和屏蔽。在匿名服务的应用场景中 （如图 \ref{fig:sss}），用户通过Deeper节点之间的安全AtomOS隧道传输数据，使得被访问的网络服务无法追踪用户的隐私数据 (例如用户的IP地址)。同时，由于AtomOS隧道中的数据包都经过了严格的加密处理，使得访问互联网干扰无法识别用
户访问的内容，从而避免了用户的访问被干扰。

\begin{figure}[hhhh]
\centering
\includegraphics[width=0.75\textwidth]{figures/sss.png}
\caption{Secure Shared Service (SSS)}
\label{fig:sss}
\end{figure}

通过Deeper独创的网络安全技术与区块链技术的结合，SSS能够有效地保证AtomOS隧道连接的安全与稳定，访问互联网不被干扰。然而，AtomOS隧道的数据传输效率，包括传输速度与传输延迟，仍然是一个有待解决的问题。在匿名服务的应用场景中，对数据传输有两大主要挑战
\begin{enumerate}
\item 匿名服务主要是为了访问更多的互联网内容。在跨国的互联网访问中，存在着数据传输距离远、高延迟、高丢包率和乱序概率的问题。
\item 虽然AtomOS隧道中的数据包都经过了严格的加密处理，使得不受干扰，但一些技术可能会针对不能识别的数据流采取随机丢包的策略 (例如 1\%的丢包) 以破坏用户体验。
\end{enumerate}

针对以上挑战，Deeper首次提出在隧道层建立面向连接的可靠的传输协议，并主要从网络拥塞控制的角度来探讨解决匿名服务中的网络数据传输效率问题。Deeper Network中的一整套拥塞控制解决方案包括两个核心部分：一是在AtomOS隧道层中实现部署一种新型的拥塞控制算法TBBR，使得在高丢包率的情况下，AtomOS隧道层任然能维持有效的数据传输速度，并且大幅降低传输延迟；二是对网络丢包事件进行快速检测并且实现快速重传，从而更好地适应匿名服务应用场景中的高丢包率环
境。

TBBR的两个核心部分均是对发送端的改进，而接收端不需要做任何改变，即发送端不依赖于接收端任何额外的信息反馈。这也是TBBR 的重要设计原则之一。在网络匿名服务的高延迟、高丢包率应用场景中，接收端任何额外的信息反馈都将无疑增加网络负载，并且在这样的环境中，无法保证任何稳定的反馈。

传统的拥塞控制算法 (例如 CUBIC \cite{ha2008cubic}, TCP Vegas \cite{brakmo1995tcp}, TCP Reno \cite{padhye2000modeling}) 通常是基
于丢包事件的，即将丢包作为网络拥塞的信号。这类算法通过一个发送窗口来控制数据的发送速度，并通过AIMD (Additive-Increase/Multiplicative-Decrease) 算法来控制在时间 $t$ 时窗口 $W(t)$ 的大小：
\begin{equation}
W(t+1) = \left\{ \begin{array}{ll}
	W(t) + \alpha & \mbox{如果没有检测到丢包} \\
	W(t) * \beta & \mbox{如果检测到丢包}
	\end{array} \right.
\end{equation}

从以上算法不难看出，这类基于丢包的拥塞控制算法的特点是在发现丢包之前会不断地增大发送速度，而一旦检测到丢包事件会突然急剧减小发送速度。由此导致两个方面的主要问题：
\begin{enumerate}
\item 将所有丢包事件都当作网络拥塞的信号是不恰当的。事实上，丢包事件也有可能是网络传输错误导致的。另外，在匿名服务的应用场景中，网络干扰也可能故意导致人为的丢包。按照AIMD算法，当丢包事件发生时，网络传输速度会急剧减小。当丢包率达到一定程度时 (例如网络干扰导致的 1\%故意丢包)，将
会导致整个网络传输几乎陷入停滞。
\item 由于在发现丢包之前都会不断地增大发送速度，这类算法倾向于占满整个网络的缓存空间。缓存中的数据包越多，就会导致网络排队延迟 (queueing delay) 越高。由于内存价格变得越来越便宜，当今网络中的缓存空间也在不断增大，从而导致上述排队延迟的问题日益严重。
\end{enumerate}
由此可见，传统的拥塞控制算法既没有达到最佳的传输速度，也没有实现最佳的网络延迟。

Deeper在AtomOS隧道层部署了一种新型的拥塞控制算法TBBR (Tunnel Bottleneck Bandwidth and Round-trip propagation time)。TBBR是在BBR \cite{cardwell2016bbr} 的基础上结合隧道技术发展而来。BBR最早由Google提出，并且已经广泛部署在Google的广域网WAN之中。不同于传统的拥塞控制算法TBBR/BBR不再依赖于丢包事件作为网络拥塞的信号，而是回归到网络拥塞的本质，即发送端向网络中发送数据的速度超过了网络的承载能力。为了测量当前网络承载能力，TBBR/BBR会不断地检测两个核心指标，即网络的瓶颈带宽 BtlBw (Bottleneck Bandwidth) 和往返传输延迟RTprop (Round-trip propagation time)。如果将网络传输通道比作一根水管，那么瓶颈带宽BtlBw 就是水管中最窄处的截面积，而往返传输延迟RTprop就是水管的长度。整个网络的容量BDP (Bandwidth Delay Product) 就是两者的乘积：
\begin{equation}
BDP = BtlBW * RTprop
\end{equation}
BDP也可以理解为在不造成任何排队延迟 (即不占用任何缓存空间) 的情况下，网络中最大可以承载的数据量。

TBBR/BBR的核心思想就是当网络瓶颈处数据到达速度刚好等于瓶颈带宽BtlBw，并且整个网络中正在通过的数据量刚好等于网络容量BDP时，网络处于最大传输速度和最小传输延迟的最佳状态。TBBR/BBR通过测量BtlBw和RTprop来控制发送速度，使得整个网络尽可能保持最佳状态。值得注意的是整个网络的属性是不断动态变化的，因此TBBR/BBR需要不断的测量BtlBw和RTprop以及时更新发送速度。另
外，BtlBw和RTprop两个指标无法同时获得。为了测量瓶颈带宽BtlBw，我们需要在数据填满网络传输通道时才能知道网络的最大传输速度；为了测量往返传输延迟RTprop，我们需要在网络尽可能空载 (即没有排队延迟) 的时候才能知道网络的最小传输延迟。为了解决这个问题，TBBR/BBR采用两者交替测量的方式，并用一段时间窗口 $W_R$ 内的测量值来估算两个指标在当前时间 $T$ 时的值：
\begin{equation}
\hat{BtlBw} = \max(r_t), \forall t \in [T - W_R, T]
\end{equation}
\begin{equation}
\hat{RTprop} = \min(RTT_t), \forall t \in [T - W_R, T]
\end{equation}
其中 $r_t$ 为在时间 $t$ 时测得的数据传输速度，$RTT_t$ 为在时间 $t$ 时测得的往返延迟。

从TBBR/BBR的设计思想不难看出，TBBR/BBR具有以下两大特点：
\begin{enumerate}
\item 在一定的丢包概率下，TBBR/BBR仍然能保持接近网络带宽的稳定传输速度。
\item 在保持最大传输速度的情况下，TBBR/BBR并不倾向于过多地占用网络缓存空间，从而降低了排队延迟。
\end{enumerate}
Google已经在 Google.com和Youtube的服务器上部署了BBR。从 Google的实践经验来看，BBR成功地将YouTube的全球网络传输延迟的中位数降低了 53\%。在发展中国家，这个数值甚至高达 80\% \cite{cardwell2016bbr}.

Deeper独创地将BBR的成功经验引入到网络匿名服务的应用场景中，实现了世界上第一个隧道层拥塞控制协议TBBR。通过TBBR，我们发现Deeper Connect能够有效地降低跨国互联网访问的网络延迟，并且在有防火墙故意丢包的情况下仍然能够维持稳定的网络传输速度，给用户带来良好的上网体验。

\begin{figure}[hhhh]
\centering
\includegraphics[width=0.7\textwidth]{figures/tput.png}
\caption{不同丢包率下的网络传输速度}
\label{fig:tput}
\end{figure}

图 \ref{fig:tput} 对比了部署TBBR后的AtomOS隧道层与不做拥塞控制的传统隧道层
(IPSEC) 在模拟不同丢包率情况下的网络传输速度。实验环境为1个数据流，BtlBW=100Mbps，RTT=100ms。图中最上面灰色曲线代表理想情况下的传输速度，即 BtlBW * (1 - $p$ )，其中 $p$ 为丢包率。从图中可以看出，传统隧道层在丢包率 0.01\%的情况下，传输速度就只能维持在网络带宽的 30\%左右了。随着丢包率的进一步提高，传输速度只剩下带宽的 5\%，几乎停滞。作为鲜明的对比，AtomOS隧道层即便在5\% 丢包率的极端情况下，仍然能够保持与理想传输速度一致。在 15\% 丢包率下，仍然能维持 75\%带宽的传输速度。在网络匿名服务的应用场景中，假设网络干扰对无法识别的数据流造成 1\% 的故意丢包，此时AtomOS隧道层的传输速度几乎不受影响，
仍然保持理想传输速度；而传统隧道层此时传输速度几乎只相当于 5\% 的带宽了。

\begin{figure}[hhhh]
\centering
\includegraphics[width=0.7\textwidth]{figures/latency.png}
\caption{不同缓存大小情况下的网络延迟}
\label{fig:latency}
\end{figure}
图 \ref{fig:latency} 对比了AtomOS隧道层与传统隧道层在不同缓存大小情况下的网络延迟。实验环境为8个数据流，BtlBW=128kbps，RTT=40ms。传统隧道层倾向于不断占用网络缓存空间而导致其网络延迟随着缓存空间大小呈线性增加。更加严重的是，当延迟大到一定程度时，会导致不同操作系统中网络初始连接 (SYN) 超时，从而导致连接失败。与之形成鲜明对比的是，AtomOS隧道层始终保持很小的网络延迟，并且不随缓存空间大小而变化

Deeper在BBR的基础之上对于AtomOS隧道层做了进一步的优化，增加了对网络丢包事件的快速检测与快速重传

传统TCP对于网络丢包事件的检测主要有两种方法：
\begin{enumerate}
\item 如果在一段时间内没有收到接收端的确认 (ACK)，则认为该数据包丢失。这个超时重传时间被称为RTO (Retransmission Timeout)。
\item 如果从接收端收到了三次重复的确认 (duplicate ACK)，也认为发生了丢包事件，从而触发重传机制。
\end{enumerate}
在TCP中，当接收端发现有的数据包被跳过时，会导致接收端发出重复的确认。而数据包被跳过有两种可能：一是该数据包被丢掉了；二是发生了网络乱序，即原本排在该数据包后面的包先到达了接收端。因此，当发送端收到重复的确认时，并不能马上断定是否发生了丢包，而是需要在多次重复确认之后才认为大概率发生了丢包事件。如果过早地认定丢包，将会导致不必要的重传，增加网络负担；如果过晚，则会导致对丢包事件反应迟钝，效率不高。

目前通用的基于三次重复确认的快速重传机制要求发送端至少要能发出4个数据包 (即发送窗口大小至少为 4) 的情况下，才有可能出现三次重复确认；否则只能依赖RTO超时来触发重传，效率很低。因此基于三次重复确认的快速重传机制在以下
情况下效果并不理想甚至根本不起作用：
\begin{enumerate}
\item 研究表明 \cite{allman2010early} 从应用层的角度来讲，很多时候一个TCP连接总共所需要发送
的数据包不到4个。此时，目前的快速重传机制根本不起作用。
\item 网络出现拥塞导致发送窗口变得很小 (例如 <4)。
\item 接收端为了充分利用带宽，可能会延迟发送确认。在累积确认 (cumulative ACK) 的模式下，甚至会把多个确认合并为一个。此时，发送端需要发送更多的数据包才有可能触发三次重复确认。
\end{enumerate}

为了更加有效地利用快速重传机制，做到既能及时地检测到丢包事件并快速重传，同时又减少不必要的重传，TBBR采用一种动态的快速重传阈值的算法。其核心思想是当不能发送更多数据包时 (受发送窗口大小限制或者应用层没有更多数据要发送)，按照当前还未确认的数据包数量来动态调整快速重传的阈值；否则仍然沿用阈值为3。
\begin{algorithm} [hh]
\caption{Algorithm for fast retransmission threshold $\tau$ in TBBR}
\label{alg:fr}
\begin{algorithmic}[1]
\State Assume that the number of currently unacknowledged packets is $k$
\If {there are no more packets to send}
\State $\tau = \max(\min(k-1,3),0)$
\Else
\State $\tau = 3$
\EndIf
\end{algorithmic}
\end{algorithm}

关于重传超时的RTO， 传统TCP中采用一种被称为指数退避 (exponential backoff) 的算法，即如果一个数据包在当前RTO下超时，则重传该数据包，并将RTO更新为之前的两倍。在极端情况下，如果一个数据包连续 $n$ 次超时，RTO会爆炸性增长为之前的 $2^n$ 倍，极大地影响传输速度。TBBR采用一种更加平滑的RTO增长曲线，每次超时时，将RTO设为之前的1.5倍。

虽然TBBR的整体设计是关于发送端的，但是对于接收端，我们仍可做一些改进来提高网络传输效率。这其中主要包括两个方面：
\begin{enumerate}
\item 在接收端采用选择性确认 (SACK [46]) 机制。相比于累积确认机制中接收端只反馈当前还没有收到的包的最小序列号，SACK允许接收端明确地告诉发送端当前窗口中哪些包已经收到，哪些包还没有收到。当发送端需要重传时，可以选择性地只重传那些还没有被确认的包。另外，在累积确认机制下，如果有多个数据包丢失，发送端每次只能得知一个数据包的丢失，导致效率不高。而SACK则可以一次性反馈所有丢失的包的信息。研究表明，在高延迟，高丢包的网络中，采用SACK可以极大地减少重传的包的数量，提高传输效率。
\item 动态地调整确认延迟。如前面所述，接收端可以延迟发送确认信息。这样做固然可以充分利用带宽，但却也延长了数据包能够被确认的时间，并且给快速重传机制带来困难。尤其是在高延迟、高丢包率的环境中，更加需要接收端及时地确认每一个收到的数据包。因此，在接收端，可以根据当前网络的延迟和丢包状况动态的调整确认信息的延迟。
\end{enumerate}

\newpage
\section{区块链}
Deeper 链的构架分为两层, 顶层(top layer)和底层(bottom layer) (见图\ref{fig:2-layers})。顶层由数百个验
证节点组成，功能和其他的区块链一样。底层也被称为Deeper层，由数百万个Deeper设备组成。这些设备 通过提供服务来获得信用积分，例如共享带宽，提供VPN服务。

\begin{figure}[hhhh]
\centering
\includegraphics[width=0.5\textwidth]{wp-zh/figures/Deeperchain-2layers.png}
\caption{Deeper 链双层结构}
\label{fig:2-layers}
\end{figure}

与标准的 Nakamoto 共识协议不同，我们的共识机制不使用大量哈希穷举运算，因此具有较低的能耗。我们的共识机制与权益证明(PoS)类似，但验证节点的投票权取决于押金和信用分数两个因素。一方面，顶层的安全性由底层设备的信用分数来保护。加入底层的设备越多，网络就越安全。另一方面，底层的设备收到的奖励(reward)将激励更多人参与深层网络。这种闭环的形成将扩展并保护整个网络。

为了更加良性促进Deeper生态网络的发展，接下来我们将从共识机制和NPoW工作量证明机制来讨论，前者将确保区块链出块的安全性，后者将激励网络中的节点贡献行为。

\subsection{共识机制}
\subsubsection{概述}
Deeper Network采用的是信用共识机制，其中包含2个重要的机制(模块)，分别是信用制、代议制，这是构成Deeper Network 共识机制的重要核心。下面分别对这些机制进行介绍。

1）信用制：\\
信用证明，顾名思义是根据每个节点信力的多少来体现每个参与者的贡献度，并以此分配出块奖励。

获取信力主要可以通过两种方式，一种是早期通过质押DPR来获取信力，另一种是参与Deeper Chain上的网络共享与共识活动来获取信力，前一个是以资金作为担保，后一个是以付出贡献作为支持，以这样的方式DeeperNetwork就构建了一个信用体系。

每个节点通过抵押或者参与链上有意义的应用来积累自己的信力，从而共同抵抗女巫脚本攻击，而不是通过算力、财力或者存储空间来抵抗女巫脚本攻击，这种设计不但能将能源消耗和硬件浪费几乎降到零，同时也可以激励每个节点参与链上有价值的众多应用，可谓一举多得。

我们可以以现存的较为完善的美国信⽤体系为例来看待信用证明的信用制。

在美国，每个人都有一个与其一生几乎所有的信用记录相关的SSN（社会安全号码），任何人均可查到自己的信息资料，比如年龄、性别、教育背景、工作经历、与税务、保险、银行打交道时的信用状况、有无犯罪记录等等。美国信用管理协会、信用报告协会和美国收账协会通过相关的信用资料就可以为个人进行信用评级，并得到相应的贷款额度，最终影响了美国人生活的方方面面。信用证明共识机制中的信力就与之相似，用户基于信力可以获得不同的共识激励及链上治理的参与权，这非常重要。它保证了所有参与者都能有贡献，并且贡献即有所得，这也使得Deeper Network拥有很强的去中心化特点，安全性和公平性也相较其他区块链网络可以做得更好。

2）代议制度\\
说起Deeper Network的代议制，我们得回顾一下DeeperNetwork整个网络的架构。

Deeper Network是由最上层的验证节点和下一层的Deeper设备节点两层构成，上层的验证节点主要负责出块，而下层的Deeper设备节点主要负责监督和选择上层的验证节点。

这样的设计灵感来自于现实中某些国家所采用的代议制，即公民通过选举产生的代表组成议会，议会在形式上代表民意行使国家权力，在Deeper Network中，设备节点通过提供信力投票给验证节点，被选中的验证节点再代表所有的设备节点参与Deeper Network的网络共识建设。

最重要的是代议节点是为底层节点服务的，并且代议节点需要将绝大多数出块奖励分配给底层节点，这跟EOS以及类似EOS生态里的那些超级节点有本质不同。

这个架构也为Deeper Network带来了两大特性。

其一，是共识上的可扩展性。传统的区块链项目比如：比特币和以太坊，全网节点就一万多个，其实并不是不能增加节点数，而是对于网络来说节点数越多，全网达成共识的速度就会越低，所以，从共识层面来说，传统的区块链项目很难继续扩大节点数，这会影响运行效率。

⽽Deeper Network的代议制机制，是双层架构，可以允许任意数量的参与者加入到共识的建立中，并且每个节点都可以参与共识获得相应的激励，而不用影响效率，这充分体现了网络的公平性。

其二，是系统上的可扩展性。DeeperNetwork的双层架构，天然就是一个Layer1+Layer2的可扩展架构。每个DeeperNetwork的硬件设备，都有一定的计算能力，可以做到把一些诸如微支付等转账功能，在硬件设备上计算打包后，再把整体的结果上链，极大地提高整个系统的运行效率，天生自带解决可扩展性问题的特性。


Deeper 使用 HotStuff [74]作为其状态机复制(SMR)框架。HotSuff 是第一个同时具有线性 (即 O(n)) 通信复杂度和响应网络延迟（即网络延迟时间取决与实际网络速度) 的拜占庭容错 (BFT) 协议。HotStuff 从 BFT 系列的协议中抽象出链式模式，并引入了流水线结构，极大地提高了网络的吞吐量。


\begin{figure}[hhhh]
\centering
\includegraphics[width=0.7\textwidth]{wp/figures/hotstuff.png}
\caption{HotStuff流水线结构}
\label{fig:hotstuff}
\end{figure}

相比与其他BFT协议，每一轮（即提议、预提交、提交等不同阶段）中有不同投票格式，Hotstuff中的每一轮不再区别对待。对某个区块投票也可以视为对它引用的父区块的下一阶段投票。 也就是说对一个块的投票被认为是对区块本身的提议投票，同时也是对其父区块的预提交投票，对其祖父区块的提交投票，以及对其第三代祖先区块的决定性投票。块只有在其第三代区块被成功投票时才执行。与其 他BFT共识协议相比，流水线结构的引入提高了吞吐量大约3倍。

此外，HotStuff使用星形通信模式（即每个人都直接与领导节点进行通信）和门限签名(threshold signature)来确保每个块需要的网络通讯流量: 领导节点将区块发送给验证节点，验证节点生成各自的签名，领导者收集其他节点的签名然后构造一个门限签名，作为区块的有效性证明。这样可以保证最佳的通信效率。

在Tendermint和PBFT这些共识算法中，每一个区块达成共识需要2轮。Hotstuff通过增加一轮共识，同时借助于门限签名可以把领导节点变更(leader change)的复杂度变成线性的，并且保证出块速度等于实际的网络延迟。相比之下，PBFT的领导节点变更复杂度是$O(n^2)$，而Tendermint的出块速度取决与系统定义的参数，没有根据网络速度达到最优。Deeper链提供了用户隐私保护功能，因此除了需要防止针对公共区块链的女巫(Sybil)攻击外，节点还可能会遭遇政府和服务提供商有针对性的禁令， 这可能导致领导节点被封锁。由于HotStuff发起领导者变更是线性复杂度，这种单点故障不会显著降低网络运行速度。

\subsubsection{节点甄选}
在任何人都可以加入的系统中，为了保证网络的安全性，验证节点需要每隔一定时间重新选举。这就是所谓的委员会轮换。委员会轮换的时间不能够太长，也就是需要在网络大部分节点被渗透之前就进行选举。只要在两次选举的时间内，攻击者控制的节点不超过总数的$1/3$即可。

对于委员会轮换，Deeper使用基于VDF的随机信标(random beacon) \cite{boneh2018verifiable}。VDF与VRF类似，VRF是一种输出不可预测的加密函数，它还可以生成一个可用于验证VRF计算正确性的证明。相比之下，VDF 需要大量的计算步骤，因此任何机器进行VDF的计算时间大于一个系统设定的下限。而验证VDF计算结果则要快得多。通过VDF，我们在随机数的输入和输出
之间施加了一定的延迟，这样可以确保任何人都无法提前预知到随机数。

在第$k$轮中，基于$k-2$轮的门限签名来作为VDF的输入，这里k代表纪元(e信用证明h)的最后一个区块。VDF的计算延迟时间大约设定为需要两轮时间。这样，恶意领导节点没有足够时间提前得到VDF输出(决定了委员会选举的随机数)，从而操纵委员会的选举。委员会的选举参见算法 \ref{alg:vdf-selection}.

\begin{algorithm} [hh]
\caption{Algorithm for committee members selection}
\label{alg:vdf-selection}
\begin{algorithmic} [1]
\State $R$ -- the value of the randomness beacon in the current e信用证明h;
\State $H(x)$ -- a hash function;
\State $n$ -- the total number of staking validators;
\State $m$ -- the total number of selected validators;
\State $W_i$ -- the weight of the $i$-th validator in consensus;
\State $TW$ -- the sum of all validator weights in consensus;
\State
\State $C \leftarrow \{\}$
\State $S \leftarrow 0$
\For{$k \in \{0, \ldots, m-1\}$}
    \State $V \leftarrow H(R||k) \% (TW-S)$
    \State $P \leftarrow 0$
    \For{$i \in \{0, \ldots, n-1\} / C$}
        \State $P \leftarrow P + W_i$
        \If{$V < P$}
            \State $C[k] \leftarrow i$
            \State $S \leftarrow S + W_i$
            \State break
        \EndIf
    \EndFor
\EndFor
\State \Return $C$
\end{algorithmic}
\end{algorithm}

此算法意味着每个验证节点在选举时候不会被重复选中，并且每个验证节点被选中的概率与它们的权重成正比。委员会选出后，里面的节点将轮流作为领导节点。每个Epoch大概出块17,280 （即假设每块需要5秒时间，24小时的出块总量）。

\vfill
\newpage

\subsection{NPoW}
Deeper 网络由两层组成。顶层包含数百个验证节点，它们不断生成新的区块。而 Deeper 层是由数百万个 Deeper 网络设备组成的。NPoW证明允许 Deeper的网络设备通过完成各种经济价值的任务来获得新的代币。每个设备将与一个帐户相关联。设备完成的任务越多，则相应帐户获得的信用分就越高。
每个设备可以把它的信用评分委托(delegate)给验证节点。如果超过总投票权2/3的验证节点对新区块投票，则此区块被确定下来。在新的区块被确认后，这些设备将获得与其信用评分成比例的代币奖励。与现代社会的信用系统一样，每个账户的信用记录 $\mathcal{C}$, 都有一个最大值作为上限 $\mathcal{C}_{max}$.

\subsubsection{概述}
传统工作量证明常用散列函数进行复杂计算，其正向穷举过程复杂，验证过程相对简单，达成工作量证明。其缺点在于：完成运算并未产生实际收益价值，其工作结果不能为他人提供经济利益。另外，最初的工作量证明机制希望能够降低用户参与证明的门槛和过程，实现相当程度的去中心化。
然而在发展过程中逐渐偏离这个方向，算力越发集中在专门设备，违背最初设想实现的目标。为此我们提出下一代工作量证明机制，通过让节点完成很多不同的经济任务，需求方燃烧对应价值的凭证，以经济手段来证明工作量；其工作成果可为他人带来实际价值，实现合理有效的硬件资源利用；
任务分发的随机性和匿名性，确保当作弊事件发生时，难以控制获利的预期收益，以经济成本限制作弊行为的发生。

\subsubsection{EZC凭证}
对于Web3.0的应用而言，大多数项目方采用的是原生代币直接交易，但对于普通用户而言，无疑存在很高的进入门槛。由于原生代币的价值不断波动，无法为用户提供稳定可预期的服务，这阻碍了应用的大规模发展。
为此，Deeper在原生代币的基础上，构建一种稳定积分EZC(Easy Cent)，其价值锚定美金（1 EZC = $\$$.01），用于支付应用和服务费用的交易媒介，它允许以稳定可预测的价格来促进链上应用的发展和使用。
当用户燃烧EZC使用链上应用服务时，将会生成对应的工作量凭证，节点根据自己的配置规则对不同的任务进行筛选和执行，完成任务后获得相对应的工作量证明，服务节点凭借累计的工作量凭证来获取系统奖励。
EZC属于系统内发行一种应用积分，不具备交易和炒作的属性,旨在满足不熟悉区块链技术的用户需求。
通常，用户可以通过燃烧DPR获得相应的EZC，由于DPR汇率是浮动的，不同时间能够兑换的EZC数量可能不同；此外，用户还可以通过传统信用卡、Paypal等形式获得EZC。

\subsubsection{安全性分析}
预防女巫(Sybil) 攻击是公共区块链的一个关键安全考量。在以太坊 1.0之后，许多区块链采用权益证明，被选出的验证节点通过协作投票决定下一个新区块的诞生，节点的投票权与它抵押的代币总量成比例。
我们使用类似权益证明的方法来出块，但节点的投票权不仅取决于抵押的代币，还取决于委托给它的信用分数。因此，Deeper链实际上是权益证明和信用证明的结合。权益证明的安全性已经被很多项目进行了深入的研究。因此，我们主要关心的是信用证明的安全性。

保证信用证明安全性的第一步是控制 Deeper网络中恶意节点的数量。为了实现这一目标，我们的协议增加了恶意控制节点的难度和成本，包括两个方面是：1）抵押代币。所有设备在注册加入网络时都需要存入一定数量的代币作为抵押。因此，如果恶意方想要控制大量的节点，它必须首先存放大量的代币，这本质上就是利益证明机制。2）最低信用要求。一个节点在加入网络后，在它可以获得奖励之前，必须达到最小的信用阈值$\tau$。通过这种方式，我们鼓励用户参与带宽共享来积累积分，同时也防止新创建的恶意节点加入网络后就可以得到奖励。

接下来，我们将从奖励的分配方式和信用积分更新来讨论 信用证明 的安全性。假设
一个服务端节点在一定时间内从$m$个客户收集付款 $[p_1, p_2,\cdots,p_m]$，并获得代币奖励 $R$。交易佣金比例为$\mu$。净利润$P$ 由以下公式得出：

\begin{equation}
    P = R + (1-\mu)*(p_1+p_2+\ldots+p_m)
\end{equation}

现在我们来分析信用证明 的安全性。假设恶意方可以控制比例$\theta$(例如$\theta=10\%$)的设备(假设设备总数$n$)，在每个期间，假设一个恶意节点随机选取 $k$个邻居，其中恶意节点的个数为随机变量$X$，存在$i$个恶意邻居的概率为：
\begin{equation}
    P(X=i) = \frac{\binom{n\theta}{i} \binom{n(1-\theta)}{k-i}}{\binom{n}{k}}
\end{equation}

假设 $k$ 相对于 $n$ (i.e., $k \ll n$) 较小, 则有一个恶意邻居的概率接近 $\theta$ (i.e., $P(X=1) \approx \theta$) 而有多个恶意邻居的概率 $P(X>1)$ 远小于 $\theta$. 假设该恶意服务器是虚设的，不能实际提供网络带宽，因此只能向其恶意邻居节点收取费用，则净利润为 $P = R + (1-\mu)*p_1$, 这里假设它只能获得一个恶意邻居，因为多个恶意邻居概率极低。

\textbf{设计1}: 注意到奖励 $R$ 是关于 $[p_1,p_2,\ldots,p_m]$的函数.  当$m=1$时，我们定义$R=0$，也就是说，如果一个服务器只服务了一个邻居，则收不到任何奖励。在这种情况下，恶意节点的净利润为负 $-\mu*p_1$ 而诚实节点的净利润为正 $(1-\mu)*p_1$. 这个简单的设计相当于从我们的系统中删除了信用证明 组件。

我们的假设是，从长期来看，小额支付将接近服务器节点的运营成本。因此，如果删除 信用证明，用户没有足够的动力来共享他们的带 宽。由于奖励与信用评分成正比，信用评分更新功能的设计应激励节点为更多
客户服务。即使比率 $\mu$ 不设为0时，当一个节点服务于多个节点时的奖励也可以将补偿费
用。

\textbf{设计2}: 我们也可以设置 $\mu = 0$. 在这种情况下，如果它只为一个客户端提供服务，我们不会更新服务器节点的信用分数。因为之前我们计算过随机分配时候，恶意节点匹配到两个或更多恶意节点的概率是非常小的。因此，在下
一个块 $T+1$ 更新信用分时候，我们可以通过阻尼因子  $\lambda$ 进行调整:
\begin{equation}
    \mathcal{C}(T+1) = \left\{ \begin{array}{ll}
	\min(\mathcal{C}(T) + \lambda \sum_{i=1}^{m} p_i, \mathcal{C}_{max}) & \mbox{if $m>1$} \\
	\mathcal{C}(T)& \mbox{otherwise}
	\end{array} \right.
\end{equation}

\textbf{设计3}: 在实际应用中，我们采取设计2的方案，同时系统会收取$10\%$的佣金。收取佣金有两个用途。第一个是相比方案2，收取佣金会让系统更加安全，更有效的防止女巫攻击。另一个主要通途是收取的佣金将会组成一个资金库。资金库的具体用途将会在后面的章节中详细描述。

在上面的分析中，我们假设 $\theta$ 很小，这个代表恶意设备所占有的比例。这是可以通过代币抵押和最低信用分要求做到。因此恶意方遵循协议来合法赚取奖励更加有效。

除了确保顶层出块节点的安全性，还需要分析deeper设备节点间的刷单问题。确保工作量证明的安全性可以从控制作恶节点的刷分行为和作恶成本分析。以DPN应用为例，我们的协议层控制了不同链接的随机性防止用户刷分行为，且每次微支付将扣除一定的交易费使得作恶成本大幅上升。

以DEP任务为例，Deeper节点按照策略抢单、随机执行的方式进行工作，假设任务A执行的条件是：Credit ＞ 100且任务节点数 ＞ 1000，按照多数一致性表决算法来计算最终结果，那么作恶节点需要至少控制500台信用分为100以上的设备才能够修改结果。由于任务抢单的随机性和庞大的节点总数N，
分配到作恶节点的任务概率：500/N，当节点数量越多，整体网络的安全性越高，作恶成本根据信用分和节点总数，将呈现出指数级上升的趋势。综上所述，作恶成本对于恶意方来说将非常不可控，遵守规则的收益要远大于作恶的收益。

\subsubsection{信用奖惩}

\textbf{信用衰减}: 当一个设备停止加入Deeper网络时，系统将逐渐降低其信用，直至达到预定义的阈值 $\tau_0$。 假设 $\tau$ 为用户可以通过委托信用分以获得奖励的阈值，我们设置预定义的阈值 $\tau_0 < \tau$。 如果该账户的信用评分小于 $\tau_0$, 则不存在信用评分下降的情
况。如果该账户的信用度大于 $\tau$ 且不参与网络共享活动，即长期闲置的话，其信用评分将逐渐降至 $\tau$ (大概几个月），然后其信用评分将逐渐渐进下降至 $\tau$,但不会进一步下降。

\textbf{初始信用购买}: 为了鼓励更多用户参与网络，我们需要一种方法，让他们能够尽快赚取信用分。初始信用购买就可以做到。它只作用于信用分数小于 $\tau$ 的账户(即允许用户获得奖励的阈值）。如果用户当前信用评分 $\mathcal{C}$ 小于 $\tau$, 用户可以支付 $\delta(\tau-\mathcal{C})$ 的代币来购买其积分达到 $\tau$, 其中 $\delta$ 是系统可调参数。用于购买信用的代币将作为 奖励分发给矿工，包括验证节点，抵押代币者和信用委托者。

\subsubsection{挖矿收益分配机制}
我们共设计了以下几种激励机制来鼓励更多的用户加入网络：

\textbf{出块收益}:验证人节点需要足够的质押和信用分才能达到提名门槛，获得区块链的出块资格，所以需要设备进行投票，将质押和信用分委托给某个验证人。当该验证人能够正常出块后将收到出块奖励，系统按照设备提供的信用分贡献大小进行奖励分配；

\textbf{工作量收益}:用良性可持续的工作任务来激励节点赚取收益，设备节点完成web3任务来获得EZC工作量凭证，系统自动结算前一日的EZC工作量凭证，根据当日节点贡献和总贡献的占比，系统自动计算工作奖励，用户随时可以领取已经确认的奖励；

\textbf{质押收益}:通过质押获得足够高的信力，从而在早期促进网络节点的大幅上升，系统根据信用等级向设备给与不同的质押奖励。随着网络节点的逐渐增多，节点间的可用性和链上应用生态逐渐变成新的重点，故后续将会用工作量奖励来逐步取代质押奖励。

\newpage
\section{代币经济}
\subsection{概述}
Deeper 使用的激励代币为 DPR，主要用于节点经济激励。它是Deeper Network的主要价值货币。DPR的总供应上限为 100 亿。其中 60 亿作为激励机制奖励来分配，主要的奖励机制为：NPoW、信用证明和验证人出块。除了原生DPR代币外，Deeper使用的积分为EZC，主要用于各种应用和服务的支付。

DPR作为对外的二级市场交易代币，可以在多个生态或系统中进行流动，例如波卡生态、以太坊生态和BSC生态等，其市场价格涨跌由二级市场众多参与者决定；EZC作为一个对内的稳定媒介，其价值固定，仅在Deeper内部生态流动，具有不可转移、不可交易的特性，购买并使用EZC的行为不属于投资行为，它允许以稳定可预测的价格来促进生态应用的使用和发展。

% \subsection{权益机制}
% Deeper 使用权益机制和VDF 来选出一个时代(e信用证明h)的委员会成员。网络中任何参与者都可以通过抵押一定数量的DPR 来成为验证节点。

% 共识网络参与者的权重（即他们在特定 e信用证明h 被选为验证者的概率）由它账户下锁定的代币总量和信用证明的参与者总信用评级决定。$TS$ 代表 e信用证明h初始的总权益（total stake），$TC$ 代表e信用证明h初始的总信用积分（total credit）, $PS$ 代表参与者的对应权益
% （participant's stake), $PC$ 代表参与者的信用积分（participant's credit）。
% 那么参与者的共识的权重等于：

% \begin{equation}
%     (0.5 * \frac{PS}{TS} + 0.5 * \frac{PC}{TC}) 
% \end{equation}

% 根据时间表，当被选为委员会成员的验证者成为新一轮（round）的领导者
% （leader）时，将会获得区块生产的奖励。如果领导者作恶，诚实的委员会成员不会签署错误的区块提案。作恶节点会导致超时，领导者将在超时后被更换，作为惩罚，犯了错误的领导者也将无法在该轮次获得奖励。


\subsection{治理}
主要有两种治理类型：链外治理和链上治理。链外治理需要开发者和社区之间的大量协调。在 Deeper链中，我们选择后者。在大多数链上治理模型中，人们使用他们的代币来获取选项列表。例如，最常见的情况是系统只有在大多数利益相关者选择升级的情况下才能升级。

这在PoS模型里会产生一个问题。与普通用户相比，大股东拥有更多的投票权。比如一种流传的说法是区块链是由风投公司控制的，因为风投公司是早期的投资者，他们拥有大量代币。有不同的机制来解决这个问题。例如，二次投票(quadratic voting) 就是其中之一。然而，这些设计要么过于复杂，要么不能从根本上解决问题。

在 Deeper链中，我们使用信用证明来解决这个问题。对于任何系统升级或协议变更，提议者将发布一份选项列表并给出投票时间窗口。任何用户帐户都将根据其信用评分进行投票，而不是抵押代币。只要它的信用评分大于某个阈值（例如，信用总分为100，阈值为 60），那么它就是合法选民。这很类似现实生活一个人到了法定投票年龄。
在 PoS 中，一个大的利益相关者可以立即获得大量的投票权。但在信用证明体系下，大股东不能很简单快捷地提高信用评分。在 信用证明 中，一个大的利益相关者仍然可以通过分成多个账户和累积信用来获得优势，但是增加和维持信用评分需要时间和精力。当一个大的利益相关者创建并维持了大量高信用账户，这意味着她对网络的贡献比其他人更大，作为回报，她将拥有更多的投票权，这也具有合理性。总的来说，这种简单有效的设计可以极大地缓解贫富不均问题。


\subsection{资金库}
在之前讨论信用证明安全性的章节里面，我们提到了系统会收取$10\%$的微支付手续费。这里有两个目的。一个是可以防止假账户之间通过互相转账来提高信用记录。另外一个目的就是把手续费汇总起来做成一个资金库。资金库可以有很多不同的用途。

我们可以把一部分资金库用来发展区块链的生态。比如任何一个开发者都可以从资金库里申请一笔基金用来改进生态系统。比如可以开发对用户友好的工具，以及修补系统的安全漏洞等。

我们可以把一部分资金库用来回购DPR代币，并销毁。也就是说，这部分的DPR将会被兑换成稳定币，当用户销毁了对应的DPR以后，就可以获得相应数量的稳定币。这种回购机制可以帮助我们以去中心化的形式有效的控制货币的发行总量。

最后，社区将会接管资金库的运营。社区将通过自治的方式来决定资金库的使用方式。


\subsection{其他燃烧机制}
除了EZC燃烧外，我们描述了其他燃烧机制，用来平抑DPR的通胀水平。

\textbf{国库燃烧}:国库是Deeper用户进行链上治理的主要资金来源，通常其资金来自于所有链上交易的手续费和罚金，每24天为一个周期会燃烧1$\%$的资金；

\textbf{补分燃烧}:设备离线会导致信力的衰减，而信力会影响用户质押或验证人收益分配，通过燃烧DPR形式可以将信力补齐到历史最高水平，通常1信用分=50 DPR；

% \subsection{信用推荐系统}
% 信用推荐系统是激励更多用户在早期采用 Deeper network 的一种方式。这一节没有被收录在区块链部分，是因为这个系统是独立的并可以在链上或链外实现。想法如下: 信用积分高的账户可以推荐新用户加入网络。高信用积分账户推荐的新用户
% 将以一定的初始信用积分开始。当新用户积累了足够的信用积分，从而达到能够获得区块
% 奖励的阈值后，推荐者的账户也将获得一部分代币奖励。社区可以决定推荐系统生效的时长。例如，如果有效期窗口为6个月，那么在此期间之后，推荐者和被推荐者将没有奖励/初始信用积分奖励。

% 我们在这里定义了几个阈值 $C0 < C1 < C2 < C3$。$C0$ 为被推荐的新用户将收到
% 的初始信用积分。$C1$是一个账户可以委托信用积分来获得奖励的阈值。$C2$和$C3$（我们可以有更多层级，为了简单期间，这里只用两层）是一个账户可以推荐新用户的阈值。比如，如果一个账户的信用积分 $>= C2$ 但 $<= C3$，它最多可以推荐5个新用户。如果一个账户的信用积分$>= C3$，它最多可以推荐10个新用户。以下是一种可能的链上实现：

% \begin{enumerate}
%     \item  赞助者(即推荐者)根据确定性密钥方案(deterministic scheme)生成推荐密钥，通过私钥签名，并发送到被赞助地址; 
%   \item 一个被赞助地址向智能合约（$SC$）提交一个推荐密钥，$SC$重构签名者(即赞助者)，检查他们是否有赞助的资格; 
%   \item  如果检查通过，一定的初始信用积分添加到被赞助地址，同时被赞助地址添加到链上
% （可以储存为映射表，key：赞助者，value：被赞助地址的动态数组）;
%   \item 赞助者节点随时查询智能合约，检查来自每个被赞助地址的信用积分;
%   \item 如果被赞助地址信用达到奖励的资格，智能合约发送代币给赞助者作为奖励。

% \end{enumerate}

% 最后两个步骤也可以在链外完成，我们可以使用一个脚本来扫描，然后通过我们自己(开发者)的代币账户来奖励合格的赞助者。



\newpage
\section{项目规划}

\subsection{项目发展路线图}
见表 \ref{tab:roadmap}.

\begin{table} [hh]
\centering
\begin{tabular}{|l|p{12cm}|}
\hline
2018 Q3		& 无锁式操作系统 Atom OS 发布 \\
& 高性能七层网络安全检测发布 \\
& 独创三叉戟协议完成	 \\ \hline
2018 Q4		& Deeper Connect 原型机搭载 Atom OS 操作系统研制成功 \\ \hline
2019 Q1		& Deeper Connect 原型机公网测试，200+ 付费节点参与测试 \\ \hline
2019 Q2		& 与多个硅谷传统创投圈和区块链产业头部机构达成合作\\ \hline
2019 Q3		& Deeper Connect Lite 发布\\ \hline
2020 Q1    & Deeper Connect Mini 测试完成，批量生产\\ \hline
2020 Q2		& Deeper Connect Mini 上线 Indiegogo 平台 \\ \hline
2020 Q3		& 产品上线全球最大 3C 销售平台 BestBuy \\
& 与中国移动达成合作，共同开发智慧家庭，智能家居领域的网络安防产品\\ \hline
2021 Q1		& Deeper 去中心化公链完成主网上线，并开启挖矿\\ \hline
\end{tabular}
\caption{项目发展路线图} \label{tab:roadmap}
\end{table}

\subsection{代币分配计划}
我们的代币缩写为 DPR (Deeper Token)。

\noindent 代币通过以太坊存款的形式，通过法定
价值进行发行。

\noindent Deeper 项目一共发行的代币总量:100 亿枚。 (10,000,000,000).

\noindent 未发售完的 DPR 代币 将被重新分配到 “挖矿” 和奖励 (bounty) 项目中分配给社区参与者。

\subsubsection{代币分配}

我们非常感谢我们的主要贡献者 --- 各位!这也是为什么我们决定将 60\%的代币分配给社区、我们的参与者和Deeper Network的支持者（见表 \ref{tab:token-matrix}）。通过“分享即 挖掘”的理念，您可以毫不费力地享受采矿之旅并从中获利。

\begin{table} [hh]
\centering
\begin{tabular}{|l|l|l|p{9cm}|}
\hline
分项 & 分配比例 \\ \hline
挖矿 & 60\% \\ \hline
代币私募销售 & 20\% \\ \hline
团队+投资人 & 10\%	\\ \hline

市场运营 + 合作 + Token Treasure & 5\% \\ \hline
核心用户IDO & 5\% \\ \hline
\end{tabular}
\caption{代币分配} \label{tab:token-matrix}
\end{table}

\newpage
\begin{appendices}
\section{术语}

\begin{enumerate}[label={\Alph*.}]
\item IDO \\
IDO 模式不从用户手里融资，不为圈钱，只为圈人，圈的人的身份是多重身份， 他既是产品的用户使用项目的服务、又是项目的员工可以为项目来进行工作得到 报酬、因为奖励的 Token 又相当于项目的股权又有股东的身份。

\item SSS \\
Secure Shared Service 的缩写。是结合了网络安全，共享经济，区块链技术的新物 种。

\item HIPE \\
HIPE 是 Deeper 独创的数据结构。AtomOS 通过 HIPE 来对共享资源进行管理，可以实现整个网络操作系统无锁化，从而大大提高系统的可靠性，性能和可扩展性。

\item Middleman changes \\
或称中间人攻击 (英语:Man-in-the-middle attack，缩写:MITM) 在密码学和计 算机安全领域中，是指攻击者与通讯的两端分别建立独立的联系，并交换其所 收到的数据，使通讯的两端认为他们正在通过一个私密的连接与对方直接对 话，但事实上整个会话都被攻击者完全控制。

\item NAT traversal \\
NAT 穿越是指连接的服务器处于 NAT 设备之后时的连接建立问题。由于 NAT 之后的设备没有专门的公网 IP 地址，所以需要一些方法来检测是否有内网到 公网 IP 和端口的映射关系:如果有，则可能可以进行直接连接;如果没有， 则可能需要一个中介服务器来完成双向的转发，参见 STUN 协议\cite{rosenbergstun}.
\end{enumerate}

\newpage
\section{免责声明}
本白皮书是一份描述我们提出的 Deeper 平台和 Deeper 代币的概念性文件，可以随时 修改或者替换。但 Deeper 没有义务更新白皮书或向接收人提供访问任何其他信息的权 限。
本白皮书不构成在任何司法管辖区 (无论是在美国或其他地方) 购买证券的要约或 投资证券的征集，也不构成任何形式的合同。此处提供的信息未经任何监管机构审 核。发布和分发本白皮书不得解释为本白皮书符合您所在司法辖区的法律、监管要 求、规则和/或法规。
对于本文件中描述的信息、陈述、意见或其他事项的准确性或完整性，或其他与项 目相关的信息，不做任何陈述或保证。在没有限制的情况下，对于成果和任何前瞻性 或概念性陈述的合理性，不作任何陈述或保证。本文件中的任何内容均不是或不应被 视为对未来的承诺或陈述。在适用法律允许的最大范围内，对于因本白皮书或其任 何方面的任何人所引起或与之相关的任何损失或损害 (无论是否可预见) 的全部责任， 不论是由于任何疏忽、违约或未加小心，均予以免责。在责任可能受到限制但未完全 免责的情况下，应在适用法律允许的最大限度内加以限制。虽然公司已采取合理步骤 以确保此处包含的信息被准确发布且包含在适当的上下文中，但公司未对从第三方外 部来源提取的信息进行任何独立审查，也未确认此类信息和其所依据的假设的准确性 或完整性。因此，公司没有义务提供有关此类信息的准确性或完整性的陈述或保证的 任何更新。
此处提供的信息不应被解释或视为有关 Deeper、公司和/或 Deeper 代币的商业， 法律，税务或财务建议。如果您不确定相关财务和法律决策，您应向独立的专业顾 问(如财务和法律顾问) 咨询关于 Deeper 代币、Deeper 和/或公司及其各自的经营和 业务，以及你所在辖区内的加密货币和其他数字资产的一般状况。须知，您可能被 要求无限期承担任何购买 Deeper 代币的法律和财务风险，或承担在不可预见情况或 外部
因素的干扰下遭受的损失。
\end{appendices}




















\newpage

\bibliographystyle{IEEEtran1.12-hacked}
\bibliography{Deeper}
\end{document}







